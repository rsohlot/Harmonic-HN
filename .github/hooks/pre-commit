#!/bin/bash

# Pre-commit hook for security checks
# To install: cp .github/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "üîí Running security checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# Check for hardcoded secrets/API keys
echo "Checking for hardcoded secrets..."
SECRETS_PATTERN='(password|secret|api_key|apikey|token|private_key|credentials)\s*=\s*["\x27][^"\x27]+'
if git diff --cached --diff-filter=ACMR | grep -iE "$SECRETS_PATTERN" > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential hardcoded secrets detected!${NC}"
    git diff --cached --diff-filter=ACMR | grep -iE "$SECRETS_PATTERN"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No hardcoded secrets found${NC}"
fi

# Check for AWS keys
echo "Checking for AWS keys..."
if git diff --cached --diff-filter=ACMR | grep -E '(AKIA|ASIA)[A-Z0-9]{16}' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential AWS access key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No AWS keys found${NC}"
fi

# Check for private keys
echo "Checking for private keys..."
if git diff --cached --diff-filter=ACMR | grep -E 'BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Private key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No private keys found${NC}"
fi

# Check for Google API keys
echo "Checking for Google API keys..."
if git diff --cached --diff-filter=ACMR | grep -E 'AIza[0-9A-Za-z\\-_]{35}' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Potential Google API key detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No Google API keys found${NC}"
fi

# Check for local paths
echo "Checking for local paths..."
if git diff --cached --diff-filter=ACMR | grep -E '(/Users/[a-zA-Z0-9_-]+/|/home/[a-zA-Z0-9_-]+/)' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Local path detected!${NC}"
    git diff --cached --diff-filter=ACMR | grep -E '(/Users/[a-zA-Z0-9_-]+/|/home/[a-zA-Z0-9_-]+/)'
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No local paths found${NC}"
fi

# Check for internal IPs
echo "Checking for internal IP addresses..."
if git diff --cached --diff-filter=ACMR | grep -E '(192\.168\.[0-9]+\.[0-9]+|10\.[0-9]+\.[0-9]+\.[0-9]+)' > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Internal IP address detected!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì No internal IPs found${NC}"
fi

# Summary
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Security check failed with $ERRORS error(s)${NC}"
    echo "Please fix the issues above before committing."
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úì All security checks passed${NC}"
    exit 0
fi
